# Offeråˆ é™¤ä¸Adsè´¦å·ç®¡ç†åŠŸèƒ½è®¾è®¡

**åˆ›å»ºæ—¥æœŸ**: 2025-01-18
**ç‰ˆæœ¬**: 1.0
**çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å¼€å‘

---

## ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [ä¸šåŠ¡é€»è¾‘](#ä¸šåŠ¡é€»è¾‘)
4. [APIè®¾è®¡](#apiè®¾è®¡)
5. [å‰ç«¯UIè®¾è®¡](#å‰ç«¯uiè®¾è®¡)
6. [æŠ€æœ¯å®ç°ç»†èŠ‚](#æŠ€æœ¯å®ç°ç»†èŠ‚)
7. [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)
8. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
9. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)

---

## åŠŸèƒ½æ¦‚è¿°

### 1. Offerä¸€é”®åˆ é™¤

**ç”¨æˆ·åœºæ™¯**: ç”¨æˆ·ä¸å†éœ€è¦æŸä¸ªOfferï¼Œå¸Œæœ›åˆ é™¤ä½†ä¿ç•™å†å²æ•°æ®ç”¨äºåˆ†æ

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… è½¯åˆ é™¤æœºåˆ¶ï¼ˆä¿ç•™æ‰€æœ‰å†å²æ•°æ®ï¼‰
- âœ… è‡ªåŠ¨è§£é™¤ä¸Google Adsè´¦å·çš„å…³è”å…³ç³»
- âœ… é˜²æ­¢è¯¯åˆ çš„äºŒæ¬¡ç¡®è®¤æœºåˆ¶
- âœ… å·²åˆ é™¤Offerä¸åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼ˆå¯é€‰æ‹©æŸ¥çœ‹ï¼‰
- âœ… æ”¯æŒæ¢å¤å·²åˆ é™¤çš„Offer

**ä¸šåŠ¡ä»·å€¼**:
- ğŸ“Š ä¿ç•™å®Œæ•´çš„å†å²æ•°æ®ç”¨äºåˆ†æå’Œå®¡è®¡
- ğŸ”„ è‡ªåŠ¨åŒ–å…³è”å…³ç³»æ¸…ç†ï¼Œå‡å°‘æ‰‹åŠ¨æ“ä½œ
- ğŸ›¡ï¸ é˜²æ­¢è¯¯åˆ å¯¼è‡´çš„æ•°æ®ä¸¢å¤±
- ğŸ’° é‡Šæ”¾Google Adsè´¦å·èµ„æºä¾›å…¶ä»–Offerä½¿ç”¨

### 2. æ‰‹åŠ¨è§£é™¤Adsè´¦å·å…³è”

**ç”¨æˆ·åœºæ™¯**: ç”¨æˆ·å¸Œæœ›æ›´æ¢Offerä½¿ç”¨çš„Google Adsè´¦å·ï¼Œæˆ–è€…æš‚åœæŸä¸ªOfferçš„æŠ•æ”¾ä½†ä¿ç•™Offeræ•°æ®

**æ ¸å¿ƒåŠŸèƒ½**:
- âœ… æ‰‹åŠ¨è§£é™¤Offerä¸Google Adsè´¦å·çš„å…³è”
- âœ… è§£é™¤å…³è”åè´¦å·è‡ªåŠ¨è¿›å…¥"é—²ç½®è´¦å·åˆ—è¡¨"
- âœ… é—²ç½®è´¦å·å¯è¢«å…¶ä»–Offeré‡æ–°å…³è”
- âœ… æ— éœ€é‡å¤OAuthè®¤è¯æµç¨‹
- âœ… æ”¯æŒæŸ¥çœ‹è´¦å·çš„ä½¿ç”¨å†å²

**ä¸šåŠ¡ä»·å€¼**:
- ğŸ”„ çµæ´»çš„è´¦å·èµ„æºè°ƒé…
- âš¡ é¿å…é‡å¤è®¤è¯ï¼Œæå‡æ•ˆç‡
- ğŸ“ˆ æœ€å¤§åŒ–åˆ©ç”¨æœ‰é™çš„Google Adsè´¦å·èµ„æº
- ğŸ¯ æ”¯æŒA/Bæµ‹è¯•ï¼ˆåŒä¸€äº§å“ä½¿ç”¨ä¸åŒè´¦å·ï¼‰

---

## æ•°æ®åº“è®¾è®¡

### 1. offersè¡¨æ‰©å±•

**æ–°å¢å­—æ®µ**:

```sql
-- åœ¨ç°æœ‰offersè¡¨åŸºç¡€ä¸Šæ·»åŠ ä»¥ä¸‹å­—æ®µ
ALTER TABLE offers ADD COLUMN is_deleted BOOLEAN NOT NULL DEFAULT 0;
ALTER TABLE offers ADD COLUMN deleted_at TEXT;
ALTER TABLE offers ADD COLUMN deleted_by INTEGER;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_offers_is_deleted ON offers(is_deleted);
CREATE INDEX idx_offers_deleted_at ON offers(deleted_at);
```

**å­—æ®µè¯´æ˜**:
- `is_deleted`: è½¯åˆ é™¤æ ‡è®°ï¼ˆ0=æœªåˆ é™¤ï¼Œ1=å·²åˆ é™¤ï¼‰
- `deleted_at`: åˆ é™¤æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰
- `deleted_by`: åˆ é™¤æ“ä½œçš„ç”¨æˆ·IDï¼ˆæœªæ¥å¤šç”¨æˆ·æ”¯æŒï¼‰

### 2. google_ads_accountsè¡¨æ‰©å±•

**æ–°å¢å­—æ®µ**:

```sql
-- åœ¨ç°æœ‰google_ads_accountsè¡¨åŸºç¡€ä¸Šæ·»åŠ ä»¥ä¸‹å­—æ®µ
ALTER TABLE google_ads_accounts ADD COLUMN status TEXT NOT NULL DEFAULT 'active';
ALTER TABLE google_ads_accounts ADD COLUMN last_disconnected_at TEXT;
ALTER TABLE google_ads_accounts ADD COLUMN disconnected_from_offer_id INTEGER;
ALTER TABLE google_ads_accounts ADD COLUMN disconnected_reason TEXT;

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_ads_accounts_status ON google_ads_accounts(status);
CREATE INDEX idx_ads_accounts_last_disconnected ON google_ads_accounts(last_disconnected_at);
```

**å­—æ®µè¯´æ˜**:
- `status`: è´¦å·çŠ¶æ€
  - `active`: å·²å…³è”åˆ°Offerï¼Œæ­£åœ¨ä½¿ç”¨
  - `idle`: é—²ç½®çŠ¶æ€ï¼Œæœªå…³è”ä»»ä½•Offer
  - `disabled`: å·²ç¦ç”¨ï¼ˆç”¨æˆ·æ‰‹åŠ¨ç¦ç”¨æˆ–è´¦å·å¼‚å¸¸ï¼‰
- `last_disconnected_at`: æœ€åä¸€æ¬¡è§£é™¤å…³è”çš„æ—¶é—´
- `disconnected_from_offer_id`: è§£é™¤å…³è”å‰å…³è”çš„Offer ID
- `disconnected_reason`: è§£é™¤å…³è”çš„åŸå› ï¼ˆmanual | offer_deleted | user_actionï¼‰

### 3. offer_ads_account_historyè¡¨ï¼ˆæ–°å»ºï¼‰

**ç”¨é€”**: è®°å½•Offerä¸Adsè´¦å·çš„å…³è”å†å²ï¼Œç”¨äºå®¡è®¡å’Œåˆ†æ

```sql
CREATE TABLE offer_ads_account_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  offer_id INTEGER NOT NULL,
  ads_account_id INTEGER NOT NULL,
  action TEXT NOT NULL,                    -- connected | disconnected
  reason TEXT,                              -- manual | offer_deleted | account_changed | campaign_ended
  campaign_id TEXT,                         -- å…³è”æ—¶åˆ›å»ºçš„Campaign ID
  campaign_status TEXT,                     -- CampaignçŠ¶æ€å¿«ç…§
  budget_spent REAL,                        -- è§£é™¤å…³è”æ—¶çš„ç´¯è®¡æ¶ˆè´¹
  impressions INTEGER,                      -- ç´¯è®¡å±•ç¤º
  clicks INTEGER,                           -- ç´¯è®¡ç‚¹å‡»
  conversions REAL,                         -- ç´¯è®¡è½¬åŒ–
  action_by INTEGER,                        -- æ“ä½œçš„ç”¨æˆ·ID
  action_at TEXT NOT NULL DEFAULT (datetime('now')),
  metadata TEXT,                            -- JSONæ ¼å¼çš„é¢å¤–ä¿¡æ¯
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (offer_id) REFERENCES offers(id) ON DELETE CASCADE,
  FOREIGN KEY (ads_account_id) REFERENCES google_ads_accounts(id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_history_offer_id ON offer_ads_account_history(offer_id);
CREATE INDEX idx_history_ads_account_id ON offer_ads_account_history(ads_account_id);
CREATE INDEX idx_history_action_at ON offer_ads_account_history(action_at);
```

**å…³é”®è®¾è®¡**:
- ğŸ“ è®°å½•æ¯æ¬¡å…³è”å’Œè§£é™¤å…³è”çš„æ“ä½œ
- ğŸ“Š ä¿å­˜è§£é™¤å…³è”æ—¶çš„æ€§èƒ½æ•°æ®å¿«ç…§
- ğŸ” æ”¯æŒå®¡è®¡å’Œåˆ†æï¼ˆå“ªäº›è´¦å·æ•ˆæœæœ€å¥½ï¼‰
- ğŸ• å®Œæ•´çš„æ—¶é—´çº¿è¿½æº¯

---

## ä¸šåŠ¡é€»è¾‘

### 1. Offeråˆ é™¤æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"åˆ é™¤Offer"
  â†“
ã€å‰ç«¯ã€‘æ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
  - æç¤º: "åˆ é™¤åOfferå°†ä¸å†æ˜¾ç¤ºï¼Œä½†å†å²æ•°æ®ä¼šä¿ç•™"
  - æç¤º: "å·²å…³è”çš„Google Adsè´¦å·å°†è‡ªåŠ¨è§£é™¤å…³è”"
  - é€‰é¡¹: [å–æ¶ˆ] [ç¡®è®¤åˆ é™¤]
  â†“
ã€åç«¯ã€‘å¼€å§‹äº‹åŠ¡å¤„ç†
  â†“
Step 1: æ£€æŸ¥OfferçŠ¶æ€
  - æ£€æŸ¥offeræ˜¯å¦å·²åˆ é™¤ï¼ˆé˜²æ­¢é‡å¤æ“ä½œï¼‰
  - æ£€æŸ¥ç”¨æˆ·æƒé™
  â†“
Step 2: æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„Adsè´¦å·
  - æŸ¥è¯¢offers.ads_account_id
  - å¦‚æœæœ‰å…³è” â†’ æ‰§è¡Œè§£é™¤å…³è”æµç¨‹
  â†“
Step 3: æ›´æ–°OfferçŠ¶æ€
  - è®¾ç½®is_deleted = 1
  - è®¾ç½®deleted_at = å½“å‰æ—¶é—´
  - è®¾ç½®deleted_by = å½“å‰ç”¨æˆ·ID
  - ä¿æŒad_statusä¸å˜ï¼ˆä¿ç•™å†å²çŠ¶æ€ï¼‰
  â†“
Step 4: è®°å½•åˆ é™¤å†å²
  - åœ¨offer_ads_account_historyè¡¨è®°å½•disconnectedäº‹ä»¶
  - reason = 'offer_deleted'
  - ä¿å­˜å½“å‰Campaignæ€§èƒ½æ•°æ®å¿«ç…§
  â†“
Step 5: æäº¤äº‹åŠ¡
  â†“
ã€å‰ç«¯ã€‘æ˜¾ç¤ºåˆ é™¤æˆåŠŸæ¶ˆæ¯
  - "Offerå·²åˆ é™¤ï¼Œå†å²æ•°æ®å·²ä¿ç•™"
  - åˆ·æ–°Offeråˆ—è¡¨
```

### 2. æ‰‹åŠ¨è§£é™¤Adsè´¦å·å…³è”æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"è§£é™¤å…³è”"
  â†“
ã€å‰ç«¯ã€‘æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
  - æç¤º: "è§£é™¤å…³è”åï¼Œè¯¥è´¦å·å°†è¿›å…¥é—²ç½®åˆ—è¡¨"
  - æç¤º: "Campaignå°†è¢«æš‚åœï¼Œä¸ä¼šè‡ªåŠ¨åˆ é™¤"
  - é€‰é¡¹: [å–æ¶ˆ] [ç¡®è®¤è§£é™¤]
  â†“
ã€åç«¯ã€‘å¼€å§‹äº‹åŠ¡å¤„ç†
  â†“
Step 1: æ£€æŸ¥å½“å‰çŠ¶æ€
  - æ£€æŸ¥Offeræ˜¯å¦å·²å…³è”è´¦å·
  - æ£€æŸ¥ç”¨æˆ·æƒé™
  - æ£€æŸ¥CampaignçŠ¶æ€
  â†“
Step 2: æš‚åœGoogle Ads Campaign
  - è°ƒç”¨Google Ads API
  - è®¾ç½®Campaign.status = 'PAUSED'
  - è·å–Campaignæ€§èƒ½æ•°æ®ï¼ˆæ¶ˆè´¹ã€ç‚¹å‡»ã€è½¬åŒ–ç­‰ï¼‰
  â†“
Step 3: æ›´æ–°Offerè¡¨
  - è®¾ç½®ads_account_id = NULL
  - è®¾ç½®ad_status = 'disconnected'ï¼ˆæ–°çŠ¶æ€ï¼‰
  - è®¾ç½®last_ads_account_idï¼ˆè®°å½•ä¸Šä¸€ä¸ªå…³è”çš„è´¦å·ï¼‰
  â†“
Step 4: æ›´æ–°Adsè´¦å·è¡¨
  - è®¾ç½®status = 'idle'
  - è®¾ç½®last_disconnected_at = å½“å‰æ—¶é—´
  - è®¾ç½®disconnected_from_offer_id = å½“å‰Offer ID
  - è®¾ç½®disconnected_reason = 'manual'
  â†“
Step 5: è®°å½•å†å²
  - åœ¨offer_ads_account_historyè¡¨è®°å½•disconnectedäº‹ä»¶
  - ä¿å­˜Campaignæ€§èƒ½æ•°æ®å¿«ç…§
  â†“
Step 6: æäº¤äº‹åŠ¡
  â†“
ã€å‰ç«¯ã€‘æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  - "å·²è§£é™¤å…³è”ï¼Œè´¦å·å·²è¿›å…¥é—²ç½®åˆ—è¡¨"
  - åˆ·æ–°Offerè¯¦æƒ…é¡µé¢
```

### 3. é‡æ–°å…³è”é—²ç½®è´¦å·æµç¨‹

```
ç”¨æˆ·åœ¨Offerè¯¦æƒ…é¡µç‚¹å‡»"å…³è”Adsè´¦å·"
  â†“
ã€å‰ç«¯ã€‘æ˜¾ç¤ºé—²ç½®è´¦å·åˆ—è¡¨
  - æ˜¾ç¤ºæ‰€æœ‰status='idle'çš„è´¦å·
  - æ˜¾ç¤ºè´¦å·åç§°ã€æœ€åä½¿ç”¨æ—¶é—´ã€å†å²æ€§èƒ½æ•°æ®
  - ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè´¦å·
  â†“
ã€åç«¯ã€‘å¼€å§‹äº‹åŠ¡å¤„ç†
  â†“
Step 1: éªŒè¯è´¦å·çŠ¶æ€
  - æ£€æŸ¥è´¦å·æ˜¯å¦ä»ç„¶æ˜¯idleçŠ¶æ€
  - æ£€æŸ¥è´¦å·æ˜¯å¦å±äºå½“å‰ç”¨æˆ·
  - æ£€æŸ¥è´¦å·æ˜¯å¦æœ‰æ•ˆï¼ˆè°ƒç”¨Google Ads APIæµ‹è¯•è¿æ¥ï¼‰
  â†“
Step 2: åˆ›å»ºæ–°çš„Campaign
  - è°ƒç”¨"ä¸€é”®ä¸Šå¹¿å‘Š"æµç¨‹
  - ç”Ÿæˆå…³é”®è¯ã€å¹¿å‘Šåˆ›æ„ã€è®¾ç½®é¢„ç®—
  - åˆ›å»ºæ–°çš„Campaign
  â†“
Step 3: æ›´æ–°Offerè¡¨
  - è®¾ç½®ads_account_id = é€‰ä¸­çš„è´¦å·ID
  - è®¾ç½®ad_status = 'active'
  - è®¾ç½®campaign_id = æ–°åˆ›å»ºçš„Campaign ID
  â†“
Step 4: æ›´æ–°Adsè´¦å·è¡¨
  - è®¾ç½®status = 'active'
  - æ¸…ç©ºlast_disconnected_atç­‰å­—æ®µ
  â†“
Step 5: è®°å½•å†å²
  - åœ¨offer_ads_account_historyè¡¨è®°å½•connectedäº‹ä»¶
  - reason = 'manual'
  â†“
Step 6: æäº¤äº‹åŠ¡
  â†“
ã€å‰ç«¯ã€‘æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  - "å·²æˆåŠŸå…³è”è´¦å·å¹¶åˆ›å»ºCampaign"
  - è·³è½¬åˆ°Offerè¯¦æƒ…é¡µé¢
```

### 4. Offeræ¢å¤æµç¨‹ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰

```
ç”¨æˆ·åœ¨"å·²åˆ é™¤Offer"åˆ—è¡¨ä¸­ç‚¹å‡»"æ¢å¤"
  â†“
ã€åç«¯ã€‘å¼€å§‹äº‹åŠ¡å¤„ç†
  â†“
Step 1: æ£€æŸ¥OfferçŠ¶æ€
  - ç¡®è®¤is_deleted = 1
  - æ£€æŸ¥ç”¨æˆ·æƒé™
  â†“
Step 2: æ¢å¤Offer
  - è®¾ç½®is_deleted = 0
  - æ¸…ç©ºdeleted_atå’Œdeleted_by
  - ad_statusä¿æŒåŸçŠ¶æ€ï¼ˆå¯èƒ½æ˜¯disconnectedï¼‰
  â†“
Step 3: æäº¤äº‹åŠ¡
  â†“
ã€å‰ç«¯ã€‘æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  - "Offerå·²æ¢å¤"
  - æç¤ºç”¨æˆ·é‡æ–°å…³è”Adsè´¦å·ï¼ˆå¦‚æœä¹‹å‰æœ‰å…³è”ï¼‰
```

---

## APIè®¾è®¡

### 1. DELETE /api/offers/[id] - è½¯åˆ é™¤Offer

**è¯·æ±‚**:
```typescript
DELETE /api/offers/123
Authorization: Bearer <token>
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "message": "Offerå·²åˆ é™¤",
  "data": {
    "offer_id": 123,
    "deleted_at": "2025-01-18T12:00:00Z",
    "disconnected_account": {
      "account_id": 456,
      "account_name": "My Ads Account",
      "status": "idle"
    }
  }
}
```

**å“åº”å¤±è´¥ (400)**:
```json
{
  "success": false,
  "error": "Offerå·²è¢«åˆ é™¤",
  "code": "ALREADY_DELETED"
}
```

**åç«¯å®ç°**:
```typescript
// app/api/offers/[id]/route.ts
export async function DELETE(request: Request, { params }: { params: { id: string } }) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 });
  }

  const offerId = parseInt(params.id);
  const userId = session.user.id;

  // Step 1: è·å–Offerä¿¡æ¯
  const offer = db.prepare(`
    SELECT id, user_id, ads_account_id, is_deleted, offer_name
    FROM offers WHERE id = ? AND user_id = ?
  `).get(offerId, userId);

  if (!offer) {
    return NextResponse.json({ success: false, error: 'Offerä¸å­˜åœ¨' }, { status: 404 });
  }

  if (offer.is_deleted) {
    return NextResponse.json({ success: false, error: 'Offerå·²è¢«åˆ é™¤', code: 'ALREADY_DELETED' }, { status: 400 });
  }

  // Step 2: å¼€å§‹äº‹åŠ¡
  const result = db.transaction(() => {
    let disconnectedAccount = null;

    // Step 3: å¦‚æœæœ‰å…³è”çš„Adsè´¦å·ï¼Œå…ˆè§£é™¤å…³è”
    if (offer.ads_account_id) {
      disconnectedAccount = disconnectAdsAccount(offerId, offer.ads_account_id, userId, 'offer_deleted');
    }

    // Step 4: è½¯åˆ é™¤Offer
    db.prepare(`
      UPDATE offers SET
        is_deleted = 1,
        deleted_at = datetime('now'),
        deleted_by = ?
      WHERE id = ?
    `).run(userId, offerId);

    return { offer, disconnectedAccount };
  })();

  return NextResponse.json({
    success: true,
    message: 'Offerå·²åˆ é™¤',
    data: {
      offer_id: offerId,
      deleted_at: new Date().toISOString(),
      disconnected_account: result.disconnectedAccount
    }
  });
}
```

### 2. POST /api/offers/[id]/disconnect - æ‰‹åŠ¨è§£é™¤Adsè´¦å·å…³è”

**è¯·æ±‚**:
```typescript
POST /api/offers/123/disconnect
Authorization: Bearer <token>
Content-Type: application/json

{
  "reason": "åˆ‡æ¢è´¦å·æµ‹è¯•"  // å¯é€‰
}
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "message": "å·²è§£é™¤å…³è”",
  "data": {
    "offer_id": 123,
    "ads_account": {
      "account_id": 456,
      "account_name": "My Ads Account",
      "status": "idle",
      "campaign_paused": true,
      "performance_snapshot": {
        "budget_spent": 150.50,
        "impressions": 12500,
        "clicks": 340,
        "conversions": 12
      }
    }
  }
}
```

**åç«¯å®ç°**:
```typescript
// app/api/offers/[id]/disconnect/route.ts
export async function POST(request: Request, { params }: { params: { id: string } }) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 });
  }

  const offerId = parseInt(params.id);
  const userId = session.user.id;
  const body = await request.json();
  const reason = body.reason || 'æ‰‹åŠ¨è§£é™¤';

  const offer = db.prepare(`
    SELECT id, user_id, ads_account_id, campaign_id
    FROM offers WHERE id = ? AND user_id = ? AND is_deleted = 0
  `).get(offerId, userId);

  if (!offer) {
    return NextResponse.json({ success: false, error: 'Offerä¸å­˜åœ¨æˆ–å·²åˆ é™¤' }, { status: 404 });
  }

  if (!offer.ads_account_id) {
    return NextResponse.json({ success: false, error: 'Offeræœªå…³è”Adsè´¦å·' }, { status: 400 });
  }

  // è·å–Adsè´¦å·ä¿¡æ¯
  const adsAccount = db.prepare(`
    SELECT id, account_name, customer_id, encrypted_refresh_token
    FROM google_ads_accounts WHERE id = ?
  `).get(offer.ads_account_id);

  // å¼€å§‹äº‹åŠ¡
  const result = db.transaction(async () => {
    // Step 1: æš‚åœCampaign
    let performanceSnapshot = null;
    if (offer.campaign_id) {
      performanceSnapshot = await pauseCampaignAndGetPerformance(
        adsAccount.customer_id,
        adsAccount.encrypted_refresh_token,
        offer.campaign_id
      );
    }

    // Step 2: è§£é™¤å…³è”
    const disconnectResult = disconnectAdsAccount(offerId, offer.ads_account_id, userId, 'manual', reason, performanceSnapshot);

    return { adsAccount, performanceSnapshot, disconnectResult };
  })();

  return NextResponse.json({
    success: true,
    message: 'å·²è§£é™¤å…³è”',
    data: {
      offer_id: offerId,
      ads_account: {
        account_id: adsAccount.id,
        account_name: adsAccount.account_name,
        status: 'idle',
        campaign_paused: true,
        performance_snapshot: result.performanceSnapshot
      }
    }
  });
}
```

### 3. GET /api/ads-accounts/idle - è·å–é—²ç½®è´¦å·åˆ—è¡¨

**è¯·æ±‚**:
```typescript
GET /api/ads-accounts/idle
Authorization: Bearer <token>
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "data": {
    "accounts": [
      {
        "id": 456,
        "account_name": "My Ads Account",
        "customer_id": "123-456-7890",
        "status": "idle",
        "last_disconnected_at": "2025-01-15T10:30:00Z",
        "last_used_offer": {
          "offer_id": 123,
          "offer_name": "OFF-2025-001",
          "product_name": "Reolink Camera"
        },
        "historical_performance": {
          "total_budget_spent": 1250.00,
          "total_impressions": 125000,
          "total_clicks": 3400,
          "total_conversions": 120,
          "avg_ctr": 2.72,
          "avg_conversion_rate": 3.53
        }
      }
    ]
  }
}
```

**åç«¯å®ç°**:
```typescript
// app/api/ads-accounts/idle/route.ts
export async function GET(request: Request) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 });
  }

  const userId = session.user.id;

  const accounts = db.prepare(`
    SELECT
      gaa.id,
      gaa.account_name,
      gaa.customer_id,
      gaa.status,
      gaa.last_disconnected_at,
      gaa.disconnected_from_offer_id
    FROM google_ads_accounts gaa
    WHERE gaa.user_id = ? AND gaa.status = 'idle'
    ORDER BY gaa.last_disconnected_at DESC
  `).all(userId);

  const accountsWithDetails = accounts.map(account => {
    // è·å–æœ€åä½¿ç”¨çš„Offerä¿¡æ¯
    const lastOffer = db.prepare(`
      SELECT id, offer_name, product_name
      FROM offers WHERE id = ?
    `).get(account.disconnected_from_offer_id);

    // è·å–å†å²æ€§èƒ½æ•°æ®
    const historicalPerformance = db.prepare(`
      SELECT
        SUM(budget_spent) as total_budget_spent,
        SUM(impressions) as total_impressions,
        SUM(clicks) as total_clicks,
        SUM(conversions) as total_conversions
      FROM offer_ads_account_history
      WHERE ads_account_id = ?
    `).get(account.id);

    return {
      id: account.id,
      account_name: account.account_name,
      customer_id: account.customer_id,
      status: account.status,
      last_disconnected_at: account.last_disconnected_at,
      last_used_offer: lastOffer ? {
        offer_id: lastOffer.id,
        offer_name: lastOffer.offer_name,
        product_name: lastOffer.product_name
      } : null,
      historical_performance: historicalPerformance
    };
  });

  return NextResponse.json({
    success: true,
    data: { accounts: accountsWithDetails }
  });
}
```

### 4. POST /api/offers/[id]/connect - å…³è”é—²ç½®è´¦å·

**è¯·æ±‚**:
```typescript
POST /api/offers/123/connect
Authorization: Bearer <token>
Content-Type: application/json

{
  "ads_account_id": 456
}
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "message": "å·²æˆåŠŸå…³è”è´¦å·",
  "data": {
    "offer_id": 123,
    "ads_account_id": 456,
    "campaign_id": "987654321",
    "campaign_status": "PAUSED"
  }
}
```

**åç«¯å®ç°**:
```typescript
// app/api/offers/[id]/connect/route.ts
export async function POST(request: Request, { params }: { params: { id: string } }) {
  const session = await getServerSession(authOptions);
  if (!session?.user?.id) {
    return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 });
  }

  const offerId = parseInt(params.id);
  const userId = session.user.id;
  const body = await request.json();
  const adsAccountId = body.ads_account_id;

  // Step 1: éªŒè¯OfferçŠ¶æ€
  const offer = db.prepare(`
    SELECT id, user_id, ads_account_id, offer_name, product_name, target_keywords, budget_daily
    FROM offers WHERE id = ? AND user_id = ? AND is_deleted = 0
  `).get(offerId, userId);

  if (!offer) {
    return NextResponse.json({ success: false, error: 'Offerä¸å­˜åœ¨æˆ–å·²åˆ é™¤' }, { status: 404 });
  }

  if (offer.ads_account_id) {
    return NextResponse.json({ success: false, error: 'Offerå·²å…³è”å…¶ä»–è´¦å·' }, { status: 400 });
  }

  // Step 2: éªŒè¯Adsè´¦å·çŠ¶æ€
  const adsAccount = db.prepare(`
    SELECT id, user_id, account_name, customer_id, status, encrypted_refresh_token
    FROM google_ads_accounts WHERE id = ? AND user_id = ?
  `).get(adsAccountId, userId);

  if (!adsAccount) {
    return NextResponse.json({ success: false, error: 'Adsè´¦å·ä¸å­˜åœ¨' }, { status: 404 });
  }

  if (adsAccount.status !== 'idle') {
    return NextResponse.json({ success: false, error: 'Adsè´¦å·ä¸æ˜¯é—²ç½®çŠ¶æ€' }, { status: 400 });
  }

  // Step 3: åˆ›å»ºCampaignï¼ˆè°ƒç”¨"ä¸€é”®ä¸Šå¹¿å‘Š"æµç¨‹ï¼‰
  const campaignResult = await createCampaignForOffer(offer, adsAccount);

  // Step 4: æ›´æ–°æ•°æ®åº“
  const result = db.transaction(() => {
    // æ›´æ–°Offer
    db.prepare(`
      UPDATE offers SET
        ads_account_id = ?,
        campaign_id = ?,
        ad_status = 'active'
      WHERE id = ?
    `).run(adsAccountId, campaignResult.campaign_id, offerId);

    // æ›´æ–°Adsè´¦å·
    db.prepare(`
      UPDATE google_ads_accounts SET
        status = 'active',
        last_disconnected_at = NULL,
        disconnected_from_offer_id = NULL,
        disconnected_reason = NULL
      WHERE id = ?
    `).run(adsAccountId);

    // è®°å½•å†å²
    db.prepare(`
      INSERT INTO offer_ads_account_history (
        user_id, offer_id, ads_account_id, action, reason, campaign_id, campaign_status, action_by
      ) VALUES (?, ?, ?, 'connected', 'manual', ?, 'PAUSED', ?)
    `).run(userId, offerId, adsAccountId, campaignResult.campaign_id, userId);

    return campaignResult;
  })();

  return NextResponse.json({
    success: true,
    message: 'å·²æˆåŠŸå…³è”è´¦å·',
    data: {
      offer_id: offerId,
      ads_account_id: adsAccountId,
      campaign_id: result.campaign_id,
      campaign_status: 'PAUSED'
    }
  });
}
```

### 5. POST /api/offers/[id]/restore - æ¢å¤å·²åˆ é™¤Offer

**è¯·æ±‚**:
```typescript
POST /api/offers/123/restore
Authorization: Bearer <token>
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "message": "Offerå·²æ¢å¤",
  "data": {
    "offer_id": 123,
    "offer_name": "OFF-2025-001",
    "ad_status": "disconnected",
    "needs_reconnection": true
  }
}
```

---

## å‰ç«¯UIè®¾è®¡

### 1. Offeråˆ—è¡¨é¡µé¢

**æ–°å¢åŠŸèƒ½**:
- âœ… æ¯ä¸ªOfferå¡ç‰‡å³ä¸Šè§’æ·»åŠ "åˆ é™¤"æŒ‰é’®ï¼ˆåƒåœ¾æ¡¶å›¾æ ‡ï¼‰
- âœ… é¡¶éƒ¨æ·»åŠ ç­›é€‰å™¨ï¼š[å…¨éƒ¨] [æ´»è·ƒä¸­] [å·²åˆ é™¤]
- âœ… å·²åˆ é™¤çš„Offeræ˜¾ç¤ºç°è‰²èƒŒæ™¯ + "å·²åˆ é™¤"æ ‡ç­¾

**åˆ é™¤æŒ‰é’®å®ç°**:
```typescript
// components/offers/OfferCard.tsx
export function OfferCard({ offer }: { offer: Offer }) {
  const [isDeleting, setIsDeleting] = useState(false);
  const [showDeleteDialog, setShowDeleteDialog] = useState(false);

  const handleDelete = async () => {
    setIsDeleting(true);
    try {
      const response = await fetch(`/api/offers/${offer.id}`, {
        method: 'DELETE',
      });
      const data = await response.json();

      if (data.success) {
        toast.success('Offerå·²åˆ é™¤');
        router.refresh();
      } else {
        toast.error(data.error);
      }
    } catch (error) {
      toast.error('åˆ é™¤å¤±è´¥');
    } finally {
      setIsDeleting(false);
      setShowDeleteDialog(false);
    }
  };

  return (
    <Card className={offer.is_deleted ? 'bg-gray-100' : ''}>
      <CardHeader>
        <div className="flex justify-between items-start">
          <div>
            <CardTitle>{offer.offer_name}</CardTitle>
            {offer.is_deleted && (
              <Badge variant="secondary">å·²åˆ é™¤</Badge>
            )}
          </div>
          {!offer.is_deleted && (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" size="icon">
                  <MoreVertical className="h-4 w-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => setShowDeleteDialog(true)}>
                  <Trash2 className="h-4 w-4 mr-2" />
                  åˆ é™¤Offer
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          )}
        </div>
      </CardHeader>

      {/* åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† */}
      <AlertDialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>ç¡®è®¤åˆ é™¤Offerï¼Ÿ</AlertDialogTitle>
            <AlertDialogDescription>
              åˆ é™¤åOfferå°†ä¸å†æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ï¼Œä½†å†å²æ•°æ®ä¼šä¿ç•™ç”¨äºåˆ†æã€‚
              {offer.ads_account_id && (
                <div className="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                  <p className="text-sm text-yellow-800">
                    âš ï¸ æ­¤Offerå·²å…³è”Google Adsè´¦å·ï¼Œåˆ é™¤åå°†è‡ªåŠ¨è§£é™¤å…³è”ã€‚
                  </p>
                </div>
              )}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>å–æ¶ˆ</AlertDialogCancel>
            <AlertDialogAction onClick={handleDelete} disabled={isDeleting}>
              {isDeleting ? 'åˆ é™¤ä¸­...' : 'ç¡®è®¤åˆ é™¤'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </Card>
  );
}
```

### 2. Offerè¯¦æƒ…é¡µé¢ - Adsè´¦å·ç®¡ç†åŒºåŸŸ

**æ–°å¢UIç»„ä»¶**:
```typescript
// components/offers/AdsAccountManager.tsx
export function AdsAccountManager({ offer }: { offer: Offer }) {
  const [isDisconnecting, setIsDisconnecting] = useState(false);
  const [showDisconnectDialog, setShowDisconnectDialog] = useState(false);
  const [showIdleAccountsDialog, setShowIdleAccountsDialog] = useState(false);

  const handleDisconnect = async () => {
    setIsDisconnecting(true);
    try {
      const response = await fetch(`/api/offers/${offer.id}/disconnect`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reason: 'æ‰‹åŠ¨è§£é™¤å…³è”' })
      });
      const data = await response.json();

      if (data.success) {
        toast.success('å·²è§£é™¤å…³è”');
        router.refresh();
      } else {
        toast.error(data.error);
      }
    } catch (error) {
      toast.error('è§£é™¤å…³è”å¤±è´¥');
    } finally {
      setIsDisconnecting(false);
      setShowDisconnectDialog(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Google Adsè´¦å·</CardTitle>
      </CardHeader>
      <CardContent>
        {offer.ads_account_id ? (
          <div className="space-y-4">
            <div className="flex items-center justify-between p-4 border rounded-lg">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                  <ExternalLink className="h-5 w-5 text-blue-600" />
                </div>
                <div>
                  <p className="font-medium">{offer.ads_account.account_name}</p>
                  <p className="text-sm text-gray-500">Customer ID: {offer.ads_account.customer_id}</p>
                </div>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={() => setShowDisconnectDialog(true)}
              >
                <Unlink className="h-4 w-4 mr-2" />
                è§£é™¤å…³è”
              </Button>
            </div>

            {offer.campaign_id && (
              <div className="p-4 bg-gray-50 rounded-lg">
                <p className="text-sm font-medium mb-2">Campaignä¿¡æ¯</p>
                <p className="text-sm text-gray-600">Campaign ID: {offer.campaign_id}</p>
                <p className="text-sm text-gray-600">çŠ¶æ€: {offer.campaign_status}</p>
              </div>
            )}
          </div>
        ) : (
          <div className="text-center py-8">
            <p className="text-gray-500 mb-4">æ­¤Offeræœªå…³è”Google Adsè´¦å·</p>
            <Button onClick={() => setShowIdleAccountsDialog(true)}>
              <Link2 className="h-4 w-4 mr-2" />
              å…³è”é—²ç½®è´¦å·
            </Button>
          </div>
        )}

        {/* è§£é™¤å…³è”ç¡®è®¤å¯¹è¯æ¡† */}
        <AlertDialog open={showDisconnectDialog} onOpenChange={setShowDisconnectDialog}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>ç¡®è®¤è§£é™¤å…³è”ï¼Ÿ</AlertDialogTitle>
              <AlertDialogDescription>
                è§£é™¤å…³è”åï¼š
                <ul className="list-disc list-inside mt-2 space-y-1">
                  <li>Campaignå°†è¢«æš‚åœï¼ˆä¸ä¼šåˆ é™¤ï¼‰</li>
                  <li>è´¦å·å°†è¿›å…¥é—²ç½®åˆ—è¡¨</li>
                  <li>å…¶ä»–Offerå¯ä»¥ä½¿ç”¨æ­¤è´¦å·</li>
                </ul>
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>å–æ¶ˆ</AlertDialogCancel>
              <AlertDialogAction onClick={handleDisconnect} disabled={isDisconnecting}>
                {isDisconnecting ? 'è§£é™¤ä¸­...' : 'ç¡®è®¤è§£é™¤'}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

        {/* é—²ç½®è´¦å·åˆ—è¡¨å¯¹è¯æ¡† */}
        <IdleAccountsDialog
          open={showIdleAccountsDialog}
          onOpenChange={setShowIdleAccountsDialog}
          offerId={offer.id}
        />
      </CardContent>
    </Card>
  );
}
```

### 3. é—²ç½®è´¦å·åˆ—è¡¨å¯¹è¯æ¡†

```typescript
// components/offers/IdleAccountsDialog.tsx
export function IdleAccountsDialog({
  open,
  onOpenChange,
  offerId
}: {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  offerId: number;
}) {
  const [accounts, setAccounts] = useState<IdleAccount[]>([]);
  const [loading, setLoading] = useState(true);
  const [connecting, setConnecting] = useState(false);

  useEffect(() => {
    if (open) {
      fetchIdleAccounts();
    }
  }, [open]);

  const fetchIdleAccounts = async () => {
    setLoading(true);
    try {
      const response = await fetch('/api/ads-accounts/idle');
      const data = await response.json();
      if (data.success) {
        setAccounts(data.data.accounts);
      }
    } catch (error) {
      toast.error('è·å–é—²ç½®è´¦å·å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };

  const handleConnect = async (accountId: number) => {
    setConnecting(true);
    try {
      const response = await fetch(`/api/offers/${offerId}/connect`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ads_account_id: accountId })
      });
      const data = await response.json();

      if (data.success) {
        toast.success('å…³è”æˆåŠŸ');
        onOpenChange(false);
        router.refresh();
      } else {
        toast.error(data.error);
      }
    } catch (error) {
      toast.error('å…³è”å¤±è´¥');
    } finally {
      setConnecting(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>é€‰æ‹©é—²ç½®è´¦å·</DialogTitle>
          <DialogDescription>
            é€‰æ‹©ä¸€ä¸ªé—²ç½®çš„Google Adsè´¦å·å…³è”åˆ°æ­¤Offer
          </DialogDescription>
        </DialogHeader>

        {loading ? (
          <div className="text-center py-8">åŠ è½½ä¸­...</div>
        ) : accounts.length === 0 ? (
          <div className="text-center py-8">
            <p className="text-gray-500">æš‚æ— é—²ç½®è´¦å·</p>
          </div>
        ) : (
          <div className="space-y-3">
            {accounts.map(account => (
              <Card key={account.id} className="hover:border-blue-500 cursor-pointer">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h4 className="font-medium">{account.account_name}</h4>
                        <Badge variant="secondary">é—²ç½®</Badge>
                      </div>
                      <p className="text-sm text-gray-500">Customer ID: {account.customer_id}</p>

                      {account.last_used_offer && (
                        <p className="text-sm text-gray-500 mt-1">
                          æœ€åä½¿ç”¨: {account.last_used_offer.product_name} ({formatDate(account.last_disconnected_at)})
                        </p>
                      )}

                      {account.historical_performance && (
                        <div className="mt-3 grid grid-cols-4 gap-2">
                          <div className="text-center p-2 bg-gray-50 rounded">
                            <p className="text-xs text-gray-500">æ¶ˆè´¹</p>
                            <p className="text-sm font-medium">${account.historical_performance.total_budget_spent}</p>
                          </div>
                          <div className="text-center p-2 bg-gray-50 rounded">
                            <p className="text-xs text-gray-500">å±•ç¤º</p>
                            <p className="text-sm font-medium">{account.historical_performance.total_impressions.toLocaleString()}</p>
                          </div>
                          <div className="text-center p-2 bg-gray-50 rounded">
                            <p className="text-xs text-gray-500">ç‚¹å‡»</p>
                            <p className="text-sm font-medium">{account.historical_performance.total_clicks.toLocaleString()}</p>
                          </div>
                          <div className="text-center p-2 bg-gray-50 rounded">
                            <p className="text-xs text-gray-500">è½¬åŒ–</p>
                            <p className="text-sm font-medium">{account.historical_performance.total_conversions}</p>
                          </div>
                        </div>
                      )}
                    </div>

                    <Button
                      onClick={() => handleConnect(account.id)}
                      disabled={connecting}
                    >
                      {connecting ? 'å…³è”ä¸­...' : 'é€‰æ‹©æ­¤è´¦å·'}
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. è§£é™¤å…³è”çš„æ ¸å¿ƒå‡½æ•°

```typescript
// lib/ads-account/disconnect.ts
export function disconnectAdsAccount(
  offerId: number,
  adsAccountId: number,
  userId: number,
  reason: string,
  customReason?: string,
  performanceSnapshot?: any
): any {
  // Step 1: è·å–Campaignæ€§èƒ½æ•°æ®
  const campaign = db.prepare(`
    SELECT campaign_id, campaign_status
    FROM offers WHERE id = ?
  `).get(offerId);

  // Step 2: æ›´æ–°Offer
  db.prepare(`
    UPDATE offers SET
      ads_account_id = NULL,
      ad_status = 'disconnected',
      last_ads_account_id = ?
    WHERE id = ?
  `).run(adsAccountId, offerId);

  // Step 3: æ›´æ–°Adsè´¦å·
  db.prepare(`
    UPDATE google_ads_accounts SET
      status = 'idle',
      last_disconnected_at = datetime('now'),
      disconnected_from_offer_id = ?,
      disconnected_reason = ?
    WHERE id = ?
  `).run(offerId, reason, adsAccountId);

  // Step 4: è®°å½•å†å²
  db.prepare(`
    INSERT INTO offer_ads_account_history (
      user_id,
      offer_id,
      ads_account_id,
      action,
      reason,
      campaign_id,
      campaign_status,
      budget_spent,
      impressions,
      clicks,
      conversions,
      action_by,
      metadata
    ) VALUES (?, ?, ?, 'disconnected', ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `).run(
    userId,
    offerId,
    adsAccountId,
    customReason || reason,
    campaign?.campaign_id,
    campaign?.campaign_status,
    performanceSnapshot?.budget_spent || 0,
    performanceSnapshot?.impressions || 0,
    performanceSnapshot?.clicks || 0,
    performanceSnapshot?.conversions || 0,
    userId,
    JSON.stringify(performanceSnapshot || {})
  );

  return {
    account_id: adsAccountId,
    status: 'idle',
    disconnected_at: new Date().toISOString()
  };
}
```

### 2. æš‚åœCampaignå¹¶è·å–æ€§èƒ½æ•°æ®

```typescript
// lib/google-ads/pause-campaign.ts
export async function pauseCampaignAndGetPerformance(
  customerId: string,
  encryptedRefreshToken: string,
  campaignId: string
): Promise<any> {
  // Step 1: è§£å¯†Token
  const refreshToken = decryptToken(encryptedRefreshToken);

  // Step 2: åˆå§‹åŒ–Google Adså®¢æˆ·ç«¯
  const customer = googleAdsClient.Customer({
    customer_id: customerId,
    refresh_token: refreshToken
  });

  // Step 3: è·å–Campaignæ€§èƒ½æ•°æ®
  const query = `
    SELECT
      campaign.id,
      campaign.name,
      campaign.status,
      metrics.impressions,
      metrics.clicks,
      metrics.conversions,
      metrics.cost_micros
    FROM campaign
    WHERE campaign.id = ${campaignId}
  `;

  const results = await customer.query(query);
  const campaignData = results[0];

  // Step 4: æš‚åœCampaign
  await customer.campaigns.update([{
    update: {
      resource_name: `customers/${customerId}/campaigns/${campaignId}`,
      status: 'PAUSED'
    },
    update_mask: { paths: ['status'] }
  }]);

  // Step 5: è¿”å›æ€§èƒ½æ•°æ®
  return {
    budget_spent: campaignData.metrics.cost_micros / 1_000_000,
    impressions: campaignData.metrics.impressions,
    clicks: campaignData.metrics.clicks,
    conversions: campaignData.metrics.conversions,
    campaign_status: 'PAUSED'
  };
}
```

### 3. TokenåŠ å¯†è§£å¯†ï¼ˆå¤ç”¨ç°æœ‰é€»è¾‘ï¼‰

```typescript
// lib/encryption.ts
import crypto from 'crypto';

const ENCRYPTION_KEY = process.env.ENCRYPTION_KEY!; // 32å­—èŠ‚å¯†é’¥
const ALGORITHM = 'aes-256-gcm';

export function encryptToken(token: string): string {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, 'hex'), iv);

  let encrypted = cipher.update(token, 'utf8', 'hex');
  encrypted += cipher.final('hex');

  const authTag = cipher.getAuthTag();

  return `${iv.toString('hex')}:${encrypted}:${authTag.toString('hex')}`;
}

export function decryptToken(encryptedToken: string): string {
  const [ivHex, encrypted, authTagHex] = encryptedToken.split(':');

  const iv = Buffer.from(ivHex, 'hex');
  const authTag = Buffer.from(authTagHex, 'hex');

  const decipher = crypto.createDecipheriv(ALGORITHM, Buffer.from(ENCRYPTION_KEY, 'hex'), iv);
  decipher.setAuthTag(authTag);

  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');

  return decrypted;
}
```

---

## å®‰å…¨è€ƒè™‘

### 1. æƒé™éªŒè¯

**æ‰€æœ‰APIç«¯ç‚¹å¿…é¡»éªŒè¯**:
```typescript
// éªŒè¯ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ­¤Offer
const offer = db.prepare(`
  SELECT id, user_id FROM offers WHERE id = ? AND user_id = ?
`).get(offerId, session.user.id);

if (!offer) {
  return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 403 });
}
```

### 2. é˜²æ­¢é‡å¤æ“ä½œ

**åˆ é™¤æ“ä½œ**:
```typescript
if (offer.is_deleted) {
  return NextResponse.json({
    success: false,
    error: 'Offerå·²è¢«åˆ é™¤',
    code: 'ALREADY_DELETED'
  }, { status: 400 });
}
```

**è§£é™¤å…³è”æ“ä½œ**:
```typescript
if (!offer.ads_account_id) {
  return NextResponse.json({
    success: false,
    error: 'Offeræœªå…³è”Adsè´¦å·'
  }, { status: 400 });
}
```

### 3. äº‹åŠ¡å®Œæ•´æ€§

**ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**:
```typescript
const result = db.transaction(() => {
  // Step 1: æ›´æ–°Offer
  db.prepare('UPDATE offers SET ...').run(...);

  // Step 2: æ›´æ–°Adsè´¦å·
  db.prepare('UPDATE google_ads_accounts SET ...').run(...);

  // Step 3: è®°å½•å†å²
  db.prepare('INSERT INTO offer_ads_account_history ...').run(...);
})();
```

### 4. APIè°ƒç”¨å¤±è´¥å¤„ç†

**Google Ads APIè°ƒç”¨å¤±è´¥ä¸åº”é˜»æ­¢æ•°æ®åº“æ›´æ–°**:
```typescript
try {
  // å°è¯•æš‚åœCampaign
  await pauseCampaignAndGetPerformance(...);
} catch (error) {
  // è®°å½•é”™è¯¯ä½†ç»§ç»­æ‰§è¡Œ
  console.error('Failed to pause campaign:', error);
  // ä»ç„¶æ‰§è¡Œæ•°æ®åº“æ›´æ–°
}
```

---

## æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `__tests__/lib/ads-account/disconnect.test.ts`

```typescript
describe('disconnectAdsAccount', () => {
  it('should disconnect ads account and update status to idle', () => {
    // å‡†å¤‡æµ‹è¯•æ•°æ®
    const offerId = createTestOffer({ ads_account_id: 1 });

    // æ‰§è¡Œè§£é™¤å…³è”
    const result = disconnectAdsAccount(offerId, 1, userId, 'manual');

    // éªŒè¯ç»“æœ
    expect(result.status).toBe('idle');

    // éªŒè¯OfferçŠ¶æ€
    const offer = db.prepare('SELECT * FROM offers WHERE id = ?').get(offerId);
    expect(offer.ads_account_id).toBeNull();
    expect(offer.ad_status).toBe('disconnected');

    // éªŒè¯Adsè´¦å·çŠ¶æ€
    const account = db.prepare('SELECT * FROM google_ads_accounts WHERE id = 1').get();
    expect(account.status).toBe('idle');

    // éªŒè¯å†å²è®°å½•
    const history = db.prepare('SELECT * FROM offer_ads_account_history WHERE offer_id = ?').get(offerId);
    expect(history.action).toBe('disconnected');
  });
});
```

### 2. é›†æˆæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `__tests__/api/offers/delete.test.ts`

```typescript
describe('DELETE /api/offers/[id]', () => {
  it('should soft delete offer and disconnect ads account', async () => {
    // åˆ›å»ºæµ‹è¯•Offerï¼ˆå·²å…³è”Adsè´¦å·ï¼‰
    const offer = await createTestOffer({ ads_account_id: 1 });

    // å‘é€åˆ é™¤è¯·æ±‚
    const response = await fetch(`http://localhost:3000/api/offers/${offer.id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${testToken}` }
    });

    const data = await response.json();

    // éªŒè¯å“åº”
    expect(response.status).toBe(200);
    expect(data.success).toBe(true);
    expect(data.data.disconnected_account).toBeDefined();

    // éªŒè¯æ•°æ®åº“çŠ¶æ€
    const deletedOffer = db.prepare('SELECT * FROM offers WHERE id = ?').get(offer.id);
    expect(deletedOffer.is_deleted).toBe(1);
    expect(deletedOffer.ads_account_id).toBeNull();

    const account = db.prepare('SELECT * FROM google_ads_accounts WHERE id = 1').get();
    expect(account.status).toBe('idle');
  });
});
```

### 3. E2Eæµ‹è¯•ï¼ˆPlaywrightï¼‰

**æµ‹è¯•æ–‡ä»¶**: `e2e/offer-management.spec.ts`

```typescript
test('user can delete offer and see it in deleted list', async ({ page }) => {
  // ç™»å½•
  await page.goto('/login');
  await login(page);

  // è¿›å…¥Offeråˆ—è¡¨
  await page.goto('/offers');

  // ç‚¹å‡»ç¬¬ä¸€ä¸ªOfferçš„åˆ é™¤æŒ‰é’®
  await page.click('[data-testid="offer-card-1"] [data-testid="delete-button"]');

  // ç¡®è®¤åˆ é™¤å¯¹è¯æ¡†
  await page.click('[data-testid="confirm-delete"]');

  // ç­‰å¾…åˆ é™¤æˆåŠŸæ¶ˆæ¯
  await expect(page.locator('text=Offerå·²åˆ é™¤')).toBeVisible();

  // åˆ‡æ¢åˆ°"å·²åˆ é™¤"ç­›é€‰å™¨
  await page.click('[data-testid="filter-deleted"]');

  // éªŒè¯Offeræ˜¾ç¤ºåœ¨å·²åˆ é™¤åˆ—è¡¨ä¸­
  await expect(page.locator('[data-testid="offer-card-1"]')).toBeVisible();
  await expect(page.locator('[data-testid="offer-card-1"] [data-testid="deleted-badge"]')).toBeVisible();
});

test('user can disconnect and reconnect ads account', async ({ page }) => {
  // è¿›å…¥Offerè¯¦æƒ…é¡µ
  await page.goto('/offers/1');

  // ç‚¹å‡»"è§£é™¤å…³è”"æŒ‰é’®
  await page.click('[data-testid="disconnect-account"]');

  // ç¡®è®¤è§£é™¤å…³è”
  await page.click('[data-testid="confirm-disconnect"]');

  // ç­‰å¾…æˆåŠŸæ¶ˆæ¯
  await expect(page.locator('text=å·²è§£é™¤å…³è”')).toBeVisible();

  // ç‚¹å‡»"å…³è”é—²ç½®è´¦å·"æŒ‰é’®
  await page.click('[data-testid="connect-idle-account"]');

  // é€‰æ‹©ä¸€ä¸ªé—²ç½®è´¦å·
  await page.click('[data-testid="idle-account-1"] [data-testid="select-account"]');

  // ç­‰å¾…å…³è”æˆåŠŸ
  await expect(page.locator('text=å…³è”æˆåŠŸ')).toBeVisible();

  // éªŒè¯è´¦å·å·²å…³è”
  await expect(page.locator('[data-testid="connected-account"]')).toBeVisible();
});
```

---

## å®æ–½è®¡åˆ’

### Phase 1: æ•°æ®åº“è¿ç§»ï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡**:
- âœ… åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… æ·»åŠ offersè¡¨æ–°å­—æ®µï¼ˆis_deleted, deleted_at, deleted_byï¼‰
- âœ… æ·»åŠ google_ads_accountsè¡¨æ–°å­—æ®µï¼ˆstatus, last_disconnected_atç­‰ï¼‰
- âœ… åˆ›å»ºoffer_ads_account_historyè¡¨
- âœ… æ·»åŠ æ‰€æœ‰ç´¢å¼•
- âœ… æµ‹è¯•è¿ç§»è„šæœ¬

**è¿ç§»è„šæœ¬**:
```sql
-- migrations/006_offer_deletion_and_account_management.sql

-- 1. æ‰©å±•offersè¡¨
ALTER TABLE offers ADD COLUMN is_deleted BOOLEAN NOT NULL DEFAULT 0;
ALTER TABLE offers ADD COLUMN deleted_at TEXT;
ALTER TABLE offers ADD COLUMN deleted_by INTEGER;
ALTER TABLE offers ADD COLUMN last_ads_account_id INTEGER;

CREATE INDEX idx_offers_is_deleted ON offers(is_deleted);
CREATE INDEX idx_offers_deleted_at ON offers(deleted_at);

-- 2. æ‰©å±•google_ads_accountsè¡¨
ALTER TABLE google_ads_accounts ADD COLUMN status TEXT NOT NULL DEFAULT 'active';
ALTER TABLE google_ads_accounts ADD COLUMN last_disconnected_at TEXT;
ALTER TABLE google_ads_accounts ADD COLUMN disconnected_from_offer_id INTEGER;
ALTER TABLE google_ads_accounts ADD COLUMN disconnected_reason TEXT;

CREATE INDEX idx_ads_accounts_status ON google_ads_accounts(status);
CREATE INDEX idx_ads_accounts_last_disconnected ON google_ads_accounts(last_disconnected_at);

-- 3. åˆ›å»ºå†å²è®°å½•è¡¨
CREATE TABLE offer_ads_account_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  offer_id INTEGER NOT NULL,
  ads_account_id INTEGER NOT NULL,
  action TEXT NOT NULL,
  reason TEXT,
  campaign_id TEXT,
  campaign_status TEXT,
  budget_spent REAL,
  impressions INTEGER,
  clicks INTEGER,
  conversions REAL,
  action_by INTEGER,
  action_at TEXT NOT NULL DEFAULT (datetime('now')),
  metadata TEXT,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (offer_id) REFERENCES offers(id) ON DELETE CASCADE,
  FOREIGN KEY (ads_account_id) REFERENCES google_ads_accounts(id) ON DELETE CASCADE
);

CREATE INDEX idx_history_offer_id ON offer_ads_account_history(offer_id);
CREATE INDEX idx_history_ads_account_id ON offer_ads_account_history(ads_account_id);
CREATE INDEX idx_history_action_at ON offer_ads_account_history(action_at);

-- 4. åˆå§‹åŒ–ç°æœ‰æ•°æ®çš„statuså­—æ®µ
UPDATE google_ads_accounts SET status = 'active';
```

### Phase 2: åç«¯APIå®ç°ï¼ˆ3å¤©ï¼‰

**Day 1**: æ ¸å¿ƒå‡½æ•°å®ç°
- âœ… `lib/ads-account/disconnect.ts` - è§£é™¤å…³è”æ ¸å¿ƒå‡½æ•°
- âœ… `lib/google-ads/pause-campaign.ts` - æš‚åœCampaignå‡½æ•°
- âœ… å•å…ƒæµ‹è¯•

**Day 2**: APIç«¯ç‚¹å®ç°
- âœ… `DELETE /api/offers/[id]` - åˆ é™¤Offer
- âœ… `POST /api/offers/[id]/disconnect` - è§£é™¤å…³è”
- âœ… `GET /api/ads-accounts/idle` - è·å–é—²ç½®è´¦å·
- âœ… é›†æˆæµ‹è¯•

**Day 3**: é«˜çº§åŠŸèƒ½
- âœ… `POST /api/offers/[id]/connect` - å…³è”é—²ç½®è´¦å·
- âœ… `POST /api/offers/[id]/restore` - æ¢å¤å·²åˆ é™¤Offer
- âœ… é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶

### Phase 3: å‰ç«¯UIå®ç°ï¼ˆ3å¤©ï¼‰

**Day 1**: Offeråˆ—è¡¨é¡µé¢
- âœ… åˆ é™¤æŒ‰é’®å’Œç¡®è®¤å¯¹è¯æ¡†
- âœ… ç­›é€‰å™¨ï¼ˆå…¨éƒ¨/æ´»è·ƒ/å·²åˆ é™¤ï¼‰
- âœ… å·²åˆ é™¤Offerçš„æ ·å¼

**Day 2**: Offerè¯¦æƒ…é¡µé¢
- âœ… Adsè´¦å·ç®¡ç†ç»„ä»¶
- âœ… è§£é™¤å…³è”åŠŸèƒ½
- âœ… é—²ç½®è´¦å·åˆ—è¡¨å¯¹è¯æ¡†

**Day 3**: é—²ç½®è´¦å·ç®¡ç†
- âœ… é—²ç½®è´¦å·å¡ç‰‡è®¾è®¡
- âœ… å†å²æ€§èƒ½æ•°æ®å±•ç¤º
- âœ… å…³è”æµç¨‹ä¼˜åŒ–

### Phase 4: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ2å¤©ï¼‰

**Day 1**: æµ‹è¯•
- âœ… E2Eæµ‹è¯•ï¼ˆPlaywrightï¼‰
- âœ… æ€§èƒ½æµ‹è¯•
- âœ… å®‰å…¨æµ‹è¯•

**Day 2**: ä¼˜åŒ–å’Œæ–‡æ¡£
- âœ… UI/UXä¼˜åŒ–
- âœ… é”™è¯¯æ¶ˆæ¯ä¼˜åŒ–
- âœ… ç”¨æˆ·æ–‡æ¡£ç¼–å†™

### Phase 5: éƒ¨ç½²å’ŒéªŒè¯ï¼ˆ1å¤©ï¼‰

- âœ… æ•°æ®åº“è¿ç§»æ‰§è¡Œ
- âœ… åŠŸèƒ½éªŒè¯
- âœ… ç”¨æˆ·éªŒæ”¶æµ‹è¯•

**æ€»å·¥ä½œé‡**: 10ä¸ªå·¥ä½œæ—¥

---

## é™„å½•

### A. æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Offeråˆ é™¤æµç¨‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
                    ç”¨æˆ·ç‚¹å‡»"åˆ é™¤Offer"
                              â”‚
                              â†“
                    ã€å‰ç«¯ã€‘äºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†
                              â”‚
                              â†“
                    ã€åç«¯ã€‘å¼€å§‹äº‹åŠ¡å¤„ç†
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚                     â”‚
                   â†“                     â†“
          æ£€æŸ¥OfferçŠ¶æ€        æ£€æŸ¥æ˜¯å¦æœ‰å…³è”è´¦å·
                   â”‚                     â”‚
                   â”‚                     â†“
                   â”‚          æœ‰å…³è” â†’ æ‰§è¡Œè§£é™¤å…³è”
                   â”‚                     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                   æ›´æ–°Offer (is_deleted=1)
                              â”‚
                              â†“
                   è®°å½•å†å²åˆ°historyè¡¨
                              â”‚
                              â†“
                        æäº¤äº‹åŠ¡
                              â”‚
                              â†“
                   ã€å‰ç«¯ã€‘æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è§£é™¤å…³è”ä¸é—²ç½®è´¦å·ç®¡ç†æµç¨‹                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
                   ç”¨æˆ·ç‚¹å‡»"è§£é™¤å…³è”"
                              â”‚
                              â†“
                    ã€åç«¯ã€‘å¼€å§‹äº‹åŠ¡å¤„ç†
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚                     â”‚
                   â†“                     â†“
          æš‚åœCampaign            è·å–æ€§èƒ½æ•°æ®
                   â”‚                     â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
                   æ›´æ–°Offer (ads_account_id=NULL)
                              â”‚
                              â†“
                   æ›´æ–°Adsè´¦å· (status='idle')
                              â”‚
                              â†“
                   è®°å½•å†å²åˆ°historyè¡¨
                              â”‚
                              â†“
                        æäº¤äº‹åŠ¡
                              â”‚
                              â†“
                   ã€å‰ç«¯ã€‘æ˜¾ç¤ºé—²ç½®è´¦å·åˆ—è¡¨
                              â”‚
                              â†“
                   ç”¨æˆ·é€‰æ‹©è´¦å·å¹¶å…³è”
                              â”‚
                              â†“
                   åˆ›å»ºæ–°Campaignï¼ˆä¸€é”®ä¸Šå¹¿å‘Šï¼‰
                              â”‚
                              â†“
                   æ›´æ–°Offerå’Œè´¦å·çŠ¶æ€
```

### B. çŠ¶æ€æµè½¬å›¾

**Offer.ad_statusçŠ¶æ€æµè½¬**:
```
not_launched â†’ active â†’ disconnected â†’ active
     â†“             â†“          â†“
  (åˆ é™¤)        (åˆ é™¤)     (åˆ é™¤)
     â†“             â†“          â†“
  deleted       deleted    deleted
     â†“             â†“          â†“
  (æ¢å¤)        (æ¢å¤)     (æ¢å¤)
     â†“             â†“          â†“
not_launched  disconnected disconnected
```

**google_ads_accounts.statusçŠ¶æ€æµè½¬**:
```
active â†’ idle â†’ active
  â†“       â†“       â†“
disabled disabled disabled
```

### C. ç›¸å…³æ–‡æ¡£

- `TECHNICAL_SPEC_V2.md`: æ•°æ®åº“Schemaå®Œæ•´å®šä¹‰
- `API_INTEGRATION_V2.md`: Google Ads APIé›†æˆ
- `ONE_CLICK_LAUNCH.md`: "ä¸€é”®ä¸Šå¹¿å‘Š"æµç¨‹
- `RISK_ALERT_DESIGN.md`: é£é™©æç¤ºåŠŸèƒ½

---

**æ–‡æ¡£çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆ
**ä¸‹ä¸€æ­¥**: å¼€å§‹Phase 1 - æ•°æ®åº“è¿ç§»
**é¢„è®¡ä¸Šçº¿æ—¶é—´**: 10ä¸ªå·¥ä½œæ—¥å
