import { NextRequest, NextResponse } from 'next/server'
import { getServerSession } from 'next-auth'
import { authOptions } from '../../auth/[...nextauth]/route'
import { getDb } from '@/lib/db'

/**
 * GET /api/campaigns/performance
 *
 * ·Ö@	Campaigns„h°pnG;
 *
 * Query Parameters:
 * - daysBack: number (ï	Ø¤7))
 */
export async function GET(request: NextRequest) {
  try {
    // 1. ŒÁ(7«ý
    const session = await getServerSession(authOptions)
    if (!session?.user?.id) {
      return NextResponse.json(
        { error: '*ˆC' },
        { status: 401 }
      )
    }

    const userId = parseInt(session.user.id)
    const { searchParams } = new URL(request.url)
    const daysBack = parseInt(searchParams.get('daysBack') || '7')

    const db = getDb()

    // 2. ¡—åô
    const endDate = new Date().toISOString().split('T')[0]
    const startDate = new Date()
    startDate.setDate(startDate.getDate() - daysBack)
    const startDateStr = startDate.toISOString().split('T')[0]

    // 3. ·Ö@	CampaignsÊvh°pn
    const campaigns = db.prepare(`
      SELECT
        c.id,
        c.campaign_name,
        c.offer_id,
        c.status,
        c.creation_status,
        c.google_campaign_id,
        c.google_ads_account_id,
        c.budget_amount,
        c.budget_type,
        c.last_sync_at,
        c.created_at,
        o.brand as offer_brand,
        o.url as offer_url,
        COALESCE(SUM(ap.impressions), 0) as impressions,
        COALESCE(SUM(ap.clicks), 0) as clicks,
        COALESCE(SUM(ap.conversions), 0) as conversions,
        COALESCE(SUM(ap.cost_micros), 0) as cost_micros,
        CASE
          WHEN SUM(ap.impressions) > 0
          THEN ROUND(SUM(ap.clicks) * 100.0 / SUM(ap.impressions), 2)
          ELSE 0
        END as ctr,
        CASE
          WHEN SUM(ap.clicks) > 0
          THEN ROUND(SUM(ap.cost_micros) * 1.0 / SUM(ap.clicks), 0)
          ELSE 0
        END as cpc_micros,
        CASE
          WHEN SUM(ap.clicks) > 0
          THEN ROUND(SUM(ap.conversions) * 100.0 / SUM(ap.clicks), 2)
          ELSE 0
        END as conversion_rate
      FROM campaigns c
      LEFT JOIN offers o ON c.offer_id = o.id
      LEFT JOIN ad_performance ap ON c.id = ap.campaign_id
        AND ap.date >= ?
        AND ap.date <= ?
      WHERE c.user_id = ?
      GROUP BY
        c.id, c.campaign_name, c.offer_id, c.status, c.creation_status,
        c.google_campaign_id, c.google_ads_account_id, c.budget_amount,
        c.budget_type, c.last_sync_at, c.created_at, o.brand, o.url
      ORDER BY c.created_at DESC
    `).all(startDateStr, endDate, userId) as any[]

    // 4. <ÔÞpn
    const formattedCampaigns = campaigns.map(c => ({
      id: c.id,
      campaignName: c.campaign_name,
      offerId: c.offer_id,
      offerBrand: c.offer_brand,
      offerUrl: c.offer_url,
      status: c.status,
      creationStatus: c.creation_status,
      googleCampaignId: c.google_campaign_id,
      googleAdsAccountId: c.google_ads_account_id,
      budgetAmount: c.budget_amount,
      budgetType: c.budget_type,
      lastSyncAt: c.last_sync_at,
      createdAt: c.created_at,
      performance: {
        impressions: c.impressions,
        clicks: c.clicks,
        conversions: c.conversions,
        costUsd: Math.round((c.cost_micros / 1000000) * 100) / 100,
        ctr: c.ctr,
        cpcUsd: Math.round((c.cpc_micros / 1000000) * 100) / 100,
        conversionRate: c.conversion_rate,
        dateRange: {
          start: startDateStr,
          end: endDate,
          days: daysBack
        }
      }
    }))

    return NextResponse.json({
      success: true,
      campaigns: formattedCampaigns,
      summary: {
        totalCampaigns: campaigns.length,
        activeCampaigns: campaigns.filter(c => c.status === 'ENABLED').length,
        totalImpressions: campaigns.reduce((sum, c) => sum + c.impressions, 0),
        totalClicks: campaigns.reduce((sum, c) => sum + c.clicks, 0),
        totalConversions: campaigns.reduce((sum, c) => sum + c.conversions, 0),
        totalCostUsd: Math.round(campaigns.reduce((sum, c) => sum + c.cost_micros, 0) / 10000) / 100
      }
    })

  } catch (error: any) {
    console.error('Get campaigns performance error:', error)
    return NextResponse.json(
      { error: error.message || '·Öh°pn1%' },
      { status: 500 }
    )
  }
}
