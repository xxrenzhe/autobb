# Supervisord配置文件
# 用于管理AutoAds应用的所有进程

[supervisord]
# supervisord日志配置
logfile=%(here)s/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=%(here)s/tmp/supervisord.pid
nodaemon=false
# 权限配置
user=%(ENV_USER)s

[unix_http_server]
file=%(here)s/tmp/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix://%(here)s/tmp/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# ==========================================
# AutoAds Next.js 应用
# ==========================================
[program:autoads-web]
command=npm run start
directory=%(here)s
autostart=true
autorestart=true
startretries=3
stderr_logfile=%(here)s/logs/web-error.log
stdout_logfile=%(here)s/logs/web-output.log
environment=NODE_ENV="production"
user=%(ENV_USER)s
# 优雅退出
stopwaitsecs=30
stopsignal=SIGTERM
killasgroup=true
stopasgroup=true

# ==========================================
# AutoAds 定时任务调度器
# ==========================================
[program:autoads-scheduler]
command=npx tsx src/scheduler.ts
directory=%(here)s
autostart=true
autorestart=true
startretries=3
stderr_logfile=%(here)s/logs/scheduler-error.log
stdout_logfile=%(here)s/logs/scheduler-output.log
environment=NODE_ENV="production",RUN_SYNC_ON_START="false"
user=%(ENV_USER)s
# 优雅退出
stopwaitsecs=60
stopsignal=SIGTERM
killasgroup=true
stopasgroup=true

# ==========================================
# 进程组配置（便于批量管理）
# ==========================================
[group:autoads]
programs=autoads-web,autoads-scheduler
priority=999
